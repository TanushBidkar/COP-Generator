<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic COP Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .form-section h2 {
            color: #2a5298;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .file-upload {
            margin-bottom: 20px;
        }

        .file-upload label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 1.05em;
        }

        .file-upload input[type="file"] {
            display: block;
            width: 100%;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload input[type="file"]:hover {
            border-color: #2a5298;
            background: #f0f4ff;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            display: inline-block;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
            display: block;
        }

        .insurance-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 2px solid #dee2e6;
        }

        .insurance-section h3 {
            color: #2a5298;
            margin-bottom: 15px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Automatic COP Generator</h1>
            <p>Generate Certificate of Payment from Measurement Sheets</p>
        </div>
    
        <div class="content">
            <!-- INSTRUCTIONS SECTION -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                <h2 style="color: white; margin-top: 0; font-size: 24px; margin-bottom: 20px;">üìã Instructions - Please Read Carefully</h2>
                <ol style="color: white; line-height: 2; font-size: 16px; margin: 0; padding-left: 25px;">
                    <li><strong>Upload Measurement Sheet:</strong> Select your Excel measurement sheet file containing the Summary Sheet.</li>
                    <li><strong>Fill All Required Details:</strong> Complete all mandatory project information fields marked with asterisks (*).</li>
                    <li><strong>Download Digital Stamp:</strong> Click "Download Digital Stamp" button to get the official Cushman & Wakefield stamp image.</li>
                    <li><strong>Copy Macros:</strong> After downloading the COP, click "Copy Macros Code" button and paste the code into your downloaded Excel file (Press Alt + F11 to open VBA editor).</li>
                    <li><strong>Generate COP:</strong> Click the "Generate COP" button to create your Certificate of Payment Excel file.</li>
                    
                </ol>
            </div>

            <!-- REQUIRED DOWNLOADS SECTION -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.1);">
                <h3 style="color: white; margin-top: 0; margin-bottom: 20px; font-size: 20px;">üîß Required Downloads</h3>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button onclick="downloadDigitalStamp()" style="background: white; color: #f5576c; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üì• Download Digital Stamp
                    </button>
                    <button onclick="copyMacroCode()" style="background: white; color: #f5576c; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        üìã Copy Macros Code
                    </button>
                </div>
                <div class="status-message" id="macrosStatus"></div>
            </div>

            <!-- UPLOAD FILES SECTION -->
            <div class="form-section">
                <h2>üìÅ Upload Files</h2>
                <div class="file-upload">
                    <label for="measurementSheet">Measurement Sheet (Excel):</label>
                    <input type="file" id="measurementSheet" accept=".xlsx, .xls" required>
                </div>
            </div>

            <!-- PROJECT INFORMATION SECTION -->
            <div class="form-section">
                <h2>üìù Project Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="projectName">Project Name *</label>
                        <input type="text" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label for="contractor">Contractor *</label>
                        <input type="text" id="contractor" required>
                    </div>
                    <div class="form-group">
                        <label for="locCode">LOC Code *</label>
                        <input type="text" id="locCode" required>
                    </div>
                    <div class="form-group">
                        <label for="areaInSft">Area in sft *</label>
                        <input type="text" id="areaInSft" required>
                    </div>
                    <div class="form-group">
                        <label for="dateOfVisit">Date of Visit *</label>
                        <input type="date" id="dateOfVisit" required>
                    </div>
                </div>
            </div>

            <!-- PACKAGE & CONTRACT DETAILS SECTION -->
            <div class="form-section">
                <h2>üì¶ Package & Contract Details</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="packageDesc">Package Description</label>
                        <input type="text" id="packageDesc" value="Civil, Interior Fit-out & Electrical Works">
                    </div>
                    <div class="form-group">
                        <label for="poWoRef">PO WO Ref. NO. & date</label>
                        <input type="text" id="poWoRef">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="addressedTo">Addressed To</label>
                    <textarea id="addressedTo" placeholder="Enter contractor address"></textarea>
                </div>
            </div>

            <!-- INSURANCE DETAILS SECTION -->
            <div class="form-section">
                <h2>üèõÔ∏è Insurance Details</h2>
                <div class="insurance-section">
                    <h3>Contractor's AI Risk Policy</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="aiRiskBearingNo">Bearing No.</label>
                            <input type="text" id="aiRiskBearingNo">
                        </div>
                        <div class="form-group">
                            <label for="aiRiskValidUpto">Valid Upto</label>
                            <input type="text" id="aiRiskValidUpto" placeholder="DD/MM/YYYY to DD/MM/YYYY">
                        </div>
                    </div>
                </div>

                <div class="insurance-section">
                    <h3>Workman's Compensation</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="workmanBearingNo">Bearing No.</label>
                            <input type="text" id="workmanBearingNo">
                        </div>
                        <div class="form-group">
                            <label for="workmanValidUpto">Valid Upto</label>
                            <input type="text" id="workmanValidUpto" placeholder="DD/MM/YYYY to DD/MM/YYYY">
                        </div>
                    </div>
                </div>
            </div>

            <!-- GENERATE BUTTON -->
            <div style="text-align: center;">
                <button class="btn" id="generateBtn" onclick="generateCOP()">Generate COP</button>
            </div>

            <!-- LOADING SPINNER -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #667eea; font-weight: 600;">Generating COP...</p>
            </div>

            <!-- STATUS MESSAGE -->
            <div class="status-message" id="statusMessage"></div>
        </div>
    </div>

    <script>
        let measurementData = null;

        // --- NEW ADDITION: CLICK LISTENER ---
        // This triggers immediately when you click the button, BEFORE the file window opens.
        document.getElementById('measurementSheet').addEventListener('click', function(e) {
            // Confirmation popup
            const readInstructions = confirm('‚ùó IMPORTANT\n\nHave you read all the instructions carefully?\n\nClick OK if YES, Cancel if NO');
            
            // If they click Cancel (false), stop the file explorer from opening
            if (!readInstructions) {
                e.preventDefault(); 
                showMessage('Action cancelled. Please read instructions first.', 'error');
            }
        });

        // --- MODIFIED: CHANGE LISTENER ---
        // This triggers AFTER they have selected a file. 
        // (I removed the confirmation popup from here so it doesn't ask twice).
        document.getElementById('measurementSheet').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    const summarySheet = workbook.Sheets['Summary Sheet'];
                    if (!summarySheet) {
                        showMessage('Error: Summary Sheet not found in the measurement file!', 'error');
                        return;
                    }
                    
                    measurementData = XLSX.utils.sheet_to_json(summarySheet, {header: 1, defval: ''});
                    showMessage('Measurement sheet loaded successfully!', 'success');
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // --- NORMAL CODE CONTINUES BELOW THIS LINE ---
        
        function showMessage(message, type) {
            const msgDiv = document.getElementById('statusMessage');
            msgDiv.textContent = message;
            msgDiv.className = `status-message ${type}`;
            setTimeout(() => {
                msgDiv.style.display = 'none';
            }, 5000);
        }

        function formatNumber(num) {
            if (num === '' || num === null || num === undefined) return '-';
            const parsed = parseFloat(num);
            if (isNaN(parsed)) return '-';
            return parsed.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function formatCurrency(num) {
            if (num === '' || num === null || num === undefined) return '‚Çπ 0.00';
            const parsed = parseFloat(num);
            if (isNaN(parsed)) return '‚Çπ 0.00';
            return '‚Çπ ' + parsed.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];

            if (num === 0) return 'Zero';

            const crore = Math.floor(num / 10000000);
            const lakh = Math.floor((num % 10000000) / 100000);
            const thousand = Math.floor((num % 100000) / 1000);
            const hundred = Math.floor((num % 1000) / 100);
            const remainder = num % 100;

            let words = '';

            if (crore > 0) words += convertTwoDigit(crore) + ' Crore ';
            if (lakh > 0) words += convertTwoDigit(lakh) + ' Lakh ';
            if (thousand > 0) words += convertTwoDigit(thousand) + ' Thousand ';
            if (hundred > 0) words += ones[hundred] + ' Hundred ';
            if (remainder > 0) words += convertTwoDigit(remainder);

            return words.trim();

            function convertTwoDigit(n) {
                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                return tens[Math.floor(n / 10)] + ' ' + ones[n % 10];
            }
        }

        function getTodayDate() {
            const today = new Date();
            const dd = String(today.getDate()).padStart(2, '0');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const mm = monthNames[today.getMonth()];
            const yy = String(today.getFullYear()).slice(-2);
            return `${dd}-${mm}-${yy}`;
        }

        function generateCOP() {
            // Pre-requisite check confirmation
            const downloaded = confirm('‚ö†Ô∏è PRE-REQUISITE CHECK\n\n1. Have you downloaded the Digital Stamp?\n2. Have you copied the Macros Code?\n\nClick OK if YES (completed both), Cancel if NO');
            
            if (!downloaded) {
                showMessage('Please download the Digital Stamp and copy the Macros Code before generating COP.', 'error');
                return;
            }

            if (!measurementData) {
                showMessage('Please upload the measurement sheet first!', 'error');
                return;
            }

            const projectName = document.getElementById('projectName').value;
            const contractor = document.getElementById('contractor').value;
            const locCode = document.getElementById('locCode').value;
            const areaInSft = document.getElementById('areaInSft').value;
            const dateOfVisit = document.getElementById('dateOfVisit').value;

            if (!projectName || !contractor || !locCode || !areaInSft || !dateOfVisit) {
                showMessage('Please fill all required project information fields!', 'error');
                return;
            }

            document.getElementById('loading').classList.add('active');
            document.getElementById('generateBtn').disabled = true;

            setTimeout(() => {
                try {
                    const copWorkbook = generateCOPWorkbook();
                    XLSX.writeFile(copWorkbook, `COP_${contractor}_${getTodayDate()}.xlsx`);
                    showMessage('COP generated successfully!', 'success');
                } catch (error) {
                    showMessage('Error generating COP: ' + error.message, 'error');
                } finally {
                    document.getElementById('loading').classList.remove('active');
                    document.getElementById('generateBtn').disabled = false;
                }
            }, 500);
        }

        function generateCOPWorkbook() {
            const wb = XLSX.utils.book_new();

            // Extract data from measurement sheet
            const extractedData = extractMeasurementData();

            // Generate Sheet3
            const sheet3 = generateSheet3(extractedData);
            XLSX.utils.book_append_sheet(wb, sheet3, 'Sheet3');

            // Generate Sheet2
            const sheet2 = generateSheet2(extractedData);
            XLSX.utils.book_append_sheet(wb, sheet2, 'Sheet2');

            // Generate Sheet1
            const sheet1 = generateSheet1(extractedData);
            XLSX.utils.book_append_sheet(wb, sheet1, 'Sheet1');

            return wb;
        }

        function extractMeasurementData() {
            const data = {
                rows: [],
                totalWO: 0,
                totalCWI: 0,
                totalExcess: 0,
                totalSavings: 0,
                totalVariance: 0
            };

            // Find header row
            let headerIndex = -1;
            for (let i = 0; i < measurementData.length; i++) {
                const row = measurementData[i];
                const rowStr = row.join('').toLowerCase();
                if (rowStr.includes('sr.no') || rowStr.includes('particulars')) {
                    headerIndex = i;
                    break;
                }
            }

            if (headerIndex === -1) return data;

            // Extract data rows until we hit "TOTAL"
            for (let i = headerIndex + 1; i < measurementData.length; i++) {
                const row = measurementData[i];
                const particulars = String(row[1] || '').trim();
                
                if (particulars.toUpperCase().includes('TOTAL')) {
                    break;
                }

                if (particulars && row[0]) {
                    const srNo = row[0];
                    const woAmount = parseFloat(row[2]) || 0;
                    const cwiAmount = parseFloat(row[3]) || 0;
                    const excess = parseFloat(row[4]) || 0;
                    const savings = parseFloat(row[5]) || 0;
                    const total = parseFloat(row[6]) || 0;

                    data.rows.push({
                        srNo,
                        particulars,
                        woAmount,
                        cwiAmount,
                        excess,
                        savings,
                        total
                    });

                    data.totalWO += woAmount;
                    data.totalCWI += cwiAmount;
                    data.totalExcess += excess;
                    data.totalSavings += savings;
                    data.totalVariance += total;
                }
            }

            return data;
        }

        function generateSheet3(extractedData) {
            const ws_data = [];
            
            // Header section
            ws_data.push([]);
            ws_data.push([]);
            ws_data.push(['Project Name', document.getElementById('projectName').value]);
            ws_data.push(['Contractor', document.getElementById('contractor').value]);
            ws_data.push(['LOC, Code', document.getElementById('locCode').value]);
            ws_data.push(['Area in sft', document.getElementById('areaInSft').value]);
            ws_data.push(['Date of Visit', document.getElementById('dateOfVisit').value]);
            ws_data.push([]);
            ws_data.push(['S. No.', 'Particulars', 'As per WO amount in INR\n(Excl. taxes)', 'Amount certified by CWI in INR\n(Excl. taxes)', 'Variance Excluding Taxes in INR', '', '']);
            ws_data.push(['', '', '', '', 'Excess', 'Savings', 'Total']);

            // Data rows
            extractedData.rows.forEach(row => {
                ws_data.push([
                    row.srNo,
                    row.particulars,
                    row.woAmount || '-',
                    row.cwiAmount || '-',
                    row.excess || '-',
                    row.savings || '-',
                    row.total || '-'
                ]);
            });

            // Total row
            ws_data.push([
                '',
                'Total',
                extractedData.totalWO,
                extractedData.totalCWI,
                extractedData.totalExcess,
                extractedData.totalSavings,
                extractedData.totalVariance
            ]);

            // Footer
            ws_data.push([]);
            ws_data.push([]);
            ws_data.push([]);
            ws_data.push(['Prepared by']);
            ws_data.push(['Cushman & Wakefield Pvt. Ltd.']);

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 10},
                {wch: 35},
                {wch: 18},
                {wch: 18},
                {wch: 15},
                {wch: 15},
                {wch: 15}
            ];

            return ws;
        }

        function generateSheet2(extractedData) {
            const ws_data = [];
            
            // Header section
            ws_data.push([]);
            ws_data.push([]);
            ws_data.push(['Project', document.getElementById('projectName').value]);
            ws_data.push(['Contractor', document.getElementById('contractor').value]);
            ws_data.push(['LOC, Code', document.getElementById('locCode').value]);
            ws_data.push(['Area in sft', document.getElementById('areaInSft').value]);
            ws_data.push(['Date of Visit', document.getElementById('dateOfVisit').value]);
            ws_data.push([]);
            ws_data.push(['S.no', 'Description', 'As per WO (Exc GST)', 'CWI Certification (Excl. Taxes)', 'Variance CW VS WO', 'Remarks']);

            const variance = extractedData.totalWO - extractedData.totalCWI;
            ws_data.push([
                '1',
                'VALUE OF WORK DONE AS PER SUMMARY SHEET',
                extractedData.totalWO,
                extractedData.totalCWI,
                variance,
                `There is a variance of INR ${formatNumber(variance)} /- from CW verified and WO`
            ]);

            ws_data.push([]);
            ws_data.push([]);
            ws_data.push(['Prepared by']);
            ws_data.push(['Cushman & Wakefield Pvt. Ltd.']);

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            ws['!cols'] = [
                {wch: 10},
                {wch: 40},
                {wch: 18},
                {wch: 18},
                {wch: 18},
                {wch: 50}
            ];

            return ws;
        }

        function generateSheet1(extractedData) {
            const ws_data = [];
            
            const contractValue = extractedData.totalWO;
            const originalContractSum = contractValue * 1.18;
            const netChangeOrder = 0;
            const contractSumToDate = originalContractSum + netChangeOrder;
            const certifiedValue = extractedData.totalCWI;
            const totalA = certifiedValue;
            const gstValue = totalA * 0.18;
            const totalPayable = totalA + gstValue;

            ws_data.push([]);
            ws_data.push([]);
            ws_data.push(['', '', 'VENDOR PAYMENT ADVICE']);
            ws_data.push([]);
            ws_data.push(['Project Name:-', document.getElementById('projectName').value]);
            ws_data.push([]);
            ws_data.push(['Addressed To:', '', '', 'Billed To:']);
            ws_data.push([document.getElementById('addressedTo').value, '', '', 'ICICI Bank Ltd. CPC Department, Zenith House, 1st Floor,  Keshavrao Khade Marg,  Opp Race Course, Mahalaxmi,  Mumbai - 400034']);
            ws_data.push([]);
            ws_data.push(['Package :', document.getElementById('packageDesc').value, '', 'Recoverable From', 'NA']);
            ws_data.push(['Interior Contractor / Architect', document.getElementById('contractor').value, '', 'Payment Advice Ref. No.']);
            ws_data.push(['PO WO Ref. NO. & date', document.getElementById('poWoRef').value, '', 'Original Contract Sum (Incl Taxes)', formatCurrency(originalContractSum)]);
            ws_data.push(['Contract Value (Excl Taxes)', formatCurrency(contractValue), '', 'Net Change Order Value (Excl Taxes)', formatCurrency(netChangeOrder)]);
            ws_data.push(['Vendor Invoice No.', 'NA', '', 'Contract Sum To Date (Incl Taxes)', formatCurrency(contractSumToDate)]);
            ws_data.push([]);
            ws_data.push(['PAYMENT DETAILS', '', '', '(All figures are in INR)', '', 'FINAL BILL']);
            ws_data.push(['Sr No.', 'DESCRIPTION', '', '', '', '(This Bill)']);
            ws_data.push(['I']);
            ws_data.push([]);
            ws_data.push(['1.1', 'Certified Value', '', '', '', formatCurrency(certifiedValue)]);
            ws_data.push([]);
            ws_data.push(['', 'Total [A]', '', '', '', formatCurrency(totalA)]);
            ws_data.push([]);
            ws_data.push(['1.2', 'Add GST']);
            ws_data.push(['', 'a) CGST @9%', '', '', '', '-']);
            ws_data.push(['', 'b) SGST @ 9%', '', '', '', '-']);
            ws_data.push(['', 'c) IGST @ 18%', '', '', '', formatCurrency(gstValue)]);
            ws_data.push(['', 'Value of GST [B]', '', '', '', formatCurrency(gstValue)]);
            ws_data.push([]);
            ws_data.push(['', 'Total Payable Amount (C) = (A+B)', '', '', '', formatCurrency(totalPayable)]);
            ws_data.push([]);
            ws_data.push(['Note: TDS and other applicable statutory deductions to be made before releasing the Payment']);
            ws_data.push(['', 'Details Of Bank Guarantees', 'Bearing no.', 'Valid upto', 'Remarks']);
            ws_data.push(['', 'Mobilization Advance', 'NA', 'NA']);
            ws_data.push(['', 'Performance', 'NA', 'NA']);
            ws_data.push(['', 'Security/Retention', 'NA', 'NA']);
            ws_data.push(['', 'Details Of Insurances', 'Bearing no.', 'Valid upto', 'Issued by']);
            ws_data.push(['', 'Labour License', 'NA']);
            ws_data.push([]);
            ws_data.push(['', "Contractor's AI Risk Policy", document.getElementById('aiRiskBearingNo').value, document.getElementById('aiRiskValidUpto').value, 'Direct Bussiness']);
            ws_data.push(['', "Workman s Compensation", document.getElementById('workmanBearingNo').value, document.getElementById('workmanValidUpto').value, 'Direct Bussiness']);
            ws_data.push(['', 'Third Party Liability', 'NA']);
            ws_data.push([]);
            ws_data.push([]);

            const amountInWords = numberToWords(Math.floor(totalPayable));
            ws_data.push([`We hereby certify that under the terms of the agreement, an amount of INR ${formatCurrency(totalPayable)} /- (INR ${amountInWords} rupees only..) is payable to M/s. ${document.getElementById('contractor').value}.`]);
            ws_data.push(['Prepared by']);
            ws_data.push(['Cushman & Wakefield Pvt. Ltd.']);
            ws_data.push([]);
            ws_data.push([]);
            ws_data.push([]);
            ws_data.push([`Date :  ${getTodayDate()}`]);

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            
            ws['!cols'] = [
                {wch: 12},
                {wch: 35},
                {wch: 25},
                {wch: 20},
                {wch: 15},
                {wch: 20}
            ];

            return ws;
        }

        // Macros code storage
const macrosCode = `Option Explicit

Sub MASTER_Format_All_Sheets()
    '-------------------------------------------------------------------------
    ' MASTER MACRO: Formats Sheet1 (Payment Advice), Sheet2, and Sheet3
    '-------------------------------------------------------------------------
    Dim StampFilePath As Variant
    
    '--- STEP 1: GET STAMP IMAGE (ONCE) ---
    MsgBox "Please select your Digital Stamp image." & vbCrLf & _
           "This stamp will be applied to ALL sheets.", vbInformation, "Select Stamp"
            
    StampFilePath = Application.GetOpenFilename("All Files (*.*), *.*", , "Select Stamp Image")
    
    If StampFilePath = False Then
        If MsgBox("No stamp selected. Continue formatting without stamp?", vbQuestion + vbYesNo) = vbNo Then Exit Sub
        StampFilePath = ""
    End If
    
    Application.ScreenUpdating = False
    
    '--- EXECUTE FORMATTING ROUTINES ---
    ' We process Sheet 3 and 2 first, then Sheet 1
    Call Process_Sheet3(StampFilePath)
    Call Process_Sheet2(StampFilePath)
    Call Process_Sheet1(StampFilePath)
    
    Application.ScreenUpdating = True
    MsgBox "Formatting Complete for Sheet1, Sheet2, and Sheet3!", vbInformation

End Sub

'=============================================================================
' SHEET 1: VENDOR PAYMENT ADVICE (Updated: Specific Partial Bolding)
'=============================================================================
Private Sub Process_Sheet1(StampPath As Variant)
    Dim ws As Worksheet
    Dim rupee As String
    Dim i As Integer
    Dim stampPic As Picture
    
    ' Variables for text processing
    Dim FullFooterText As String
    Dim InrPos As Long
    Dim PrepPos As Long
    Dim BoldLength As Long
    
    ' Store original data
    Dim ProjectName As String, AddressedTo As String, InteriorContractor As String
    Dim POWORef As String, OrigContractSum As String, ContractValueExcl As String
    Dim ContractSumToDate As String, CertifiedValue As String, TotalA As String
    Dim IGSTValue As String, GSTValue As String, TotalPayable As String
    Dim ContractorsAI As String, ContractorsAIDate As String
    Dim WorkmanComp As String, WorkmanCompDate As String
    Dim CertText1 As String, CertText2 As String, CertText3 As String
    
    rupee = ChrW(8377)
    
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Sheet1")
    On Error GoTo 0
    
    If ws Is Nothing Then MsgBox "Sheet1 not found!", vbCritical: Exit Sub
    
    ' Fetch data
    With ws
        ProjectName = .Range("B5").Value
        AddressedTo = .Range("A8").Value
        InteriorContractor = .Range("B11").Value
        POWORef = .Range("B12").Value
        OrigContractSum = .Range("E12").Value
        ContractValueExcl = .Range("B13").Value
        ContractSumToDate = .Range("E14").Value
        CertifiedValue = .Range("F20").Value
        TotalA = .Range("F22").Value
        IGSTValue = .Range("F27").Value
        GSTValue = .Range("F28").Value
        TotalPayable = .Range("F30").Value
        ContractorsAI = .Range("C40").Value
        ContractorsAIDate = .Range("D40").Value
        WorkmanComp = .Range("C41").Value
        WorkmanCompDate = .Range("D41").Value
        CertText1 = .Range("A45").Value
        CertText2 = .Range("A46").Value
        CertText3 = .Range("A47").Value
    End With
    
    ' Clear Sheet
    ws.Activate
    ws.Cells.Clear
    Dim shp As Shape
    For Each shp In ws.Shapes
        If shp.Type = msoPicture Then shp.Delete
    Next shp
    
    ' --- 1. PAGE SETUP ---
    ws.Columns("A").ColumnWidth = 1
    ws.Columns("B").ColumnWidth = 6
    ws.Columns("C").ColumnWidth = 5
    ws.Columns("D").ColumnWidth = 40
    ws.Columns("E").ColumnWidth = 15
    ws.Columns("F").ColumnWidth = 35
    ws.Columns("G").ColumnWidth = 25
    ws.Columns("H").ColumnWidth = 25
    
    ' --- 2. HEADER ---
    With ws.Range("B2:H2")
        .Merge: .Value = "VENDOR PAYMENT ADVICE"
        .Font.Bold = True: .Font.Size = 12
        .HorizontalAlignment = xlCenter: .VerticalAlignment = xlCenter
        .Borders.LineStyle = xlContinuous: .Interior.Color = RGB(255, 255, 255)
    End With
    
    With ws.Range("B4:H4")
        .Merge: .Value = "Project Name:- " & ProjectName
        .Font.Bold = True: .Font.Size = 10
        .WrapText = True: .VerticalAlignment = xlCenter
        .Borders.LineStyle = xlContinuous
    End With
    ws.Rows(4).RowHeight = 30
    
    ' --- 3. ADDRESS ---
    ws.Range("B5:E5").Merge: ws.Range("B5").Value = "Addressed To:"
    ws.Range("F5:H5").Merge: ws.Range("F5").Value = "Billed To:"
    ws.Range("B5:H5").Font.Bold = True
    ws.Range("B5:H5").Borders.LineStyle = xlContinuous
    
    ws.Range("B6:E6").Merge
    With ws.Range("B6:E6")
        .Value = AddressedTo
        .Font.Size = 10: .WrapText = True: .VerticalAlignment = xlTop: .Borders.LineStyle = xlContinuous
    End With
    
    ws.Range("F6:H6").Merge
    With ws.Range("F6:H6")
        .Value = "ICICI Bank Ltd. CPC Department, Zenith House, 1st Floor, Keshavrao Khade Marg, Opp Race Course, Mahalaxmi, Mumbai - 400034"
        .Font.Size = 10: .WrapText = True: .VerticalAlignment = xlTop: .Borders.LineStyle = xlContinuous
    End With
    ws.Rows(6).RowHeight = 45
    
    ' --- 4. CONTRACT INFO ---
    ws.Range("B8:C8").Merge: ws.Range("B8").Value = "Package :"
    ws.Range("D8:E8").Merge: ws.Range("D8").Value = "Civil, Interior Fit-out & Electrical Works"
    ws.Range("F8").Value = "Recoverable From": ws.Range("G8:H8").Merge: ws.Range("G8").Value = "NA"
    
    ws.Range("B9:C9").Merge: ws.Range("B9").Value = "Interior Contractor / Architect"
    ws.Range("D9:E9").Merge: ws.Range("D9").Value = InteriorContractor
    ws.Range("F9").Value = "Payment Advice Ref. No.": ws.Range("G9:H9").Merge
    
    ws.Range("B10:C10").Merge: ws.Range("B10").Value = "PO WO Ref. NO. & date"
    ws.Range("D10:E10").Merge: ws.Range("D10").Value = POWORef
    ws.Range("F10").Value = "Original Contract Sum (Incl Taxes)"
    ws.Range("G10:H10").Merge: ws.Range("G10").Value = rupee & " " & OrigContractSum
    
    ws.Range("B11:C11").Merge: ws.Range("B11").Value = "Contract Value (Excl Taxes)"
    ws.Range("D11:E11").Merge: ws.Range("D11").Value = rupee & " " & ContractValueExcl
    ws.Range("F11").Value = "Net Change Order Value (Excl Taxes)"
    ws.Range("G11:H11").Merge: ws.Range("G11").Value = rupee & " 0.00"
    
    ws.Range("B12:C12").Merge: ws.Range("B12").Value = "Vendor Invoice No."
    ws.Range("D12:E12").Merge: ws.Range("D12").Value = "NA"
    ws.Range("F12").Value = "Contract Sum To Date (Incl Taxes)"
    ws.Range("G12:H12").Merge: ws.Range("G12").Value = rupee & " " & ContractSumToDate
    
    With ws.Range("B8:H12")
        .Borders.LineStyle = xlContinuous: .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter: .Font.Bold = True: .Font.Size = 9
    End With
    ws.Range("G10:H12").HorizontalAlignment = xlRight
    
    ' --- 5. PAYMENT DETAILS ---
    ws.Range("B14:E14").Merge: ws.Range("B14").Value = "PAYMENT DETAILS"
    ws.Range("F14").Value = "(All figures are in INR)"
    ws.Range("G14:H14").Merge: ws.Range("G14").Value = "FINAL BILL" & vbLf & "(This Bill)"
    
    ws.Range("B15").Value = "Sr No.": ws.Range("C15:E15").Merge: ws.Range("C15").Value = "DESCRIPTION"
    ws.Range("G15:H15").Merge
    
    With ws.Range("B14:H15")
        .Interior.Color = RGB(0, 70, 130): .Font.Color = vbWhite: .Font.Bold = True
        .HorizontalAlignment = xlCenter: .Borders.LineStyle = xlContinuous
    End With
    
    For i = 16 To 29
        ws.Range("C" & i & ":E" & i).Merge: ws.Range("G" & i & ":H" & i).Merge
    Next i
    
    With ws.Range("B16:H29")
        .Borders.LineStyle = xlContinuous: .VerticalAlignment = xlCenter
    End With
    
    ws.Range("B17").Value = "I": ws.Range("B17").HorizontalAlignment = xlCenter
    ws.Range("B19").Value = "1.1": ws.Range("B19").HorizontalAlignment = xlCenter
    ws.Range("C19").Value = "Certified Value"
    ws.Range("G19").Value = rupee & " " & CertifiedValue: ws.Range("G19").HorizontalAlignment = xlRight
    
    ws.Range("C21").Value = "Total [A]": ws.Range("C21").Font.Bold = True
    ws.Range("F21").Value = "-": ws.Range("F21").HorizontalAlignment = xlCenter
    ws.Range("G21").Value = TotalA: ws.Range("G21").Font.Bold = True: ws.Range("G21").HorizontalAlignment = xlRight
    
    ws.Range("B23").Value = "1.2": ws.Range("B23").HorizontalAlignment = xlCenter
    ws.Range("C23").Value = "Add GST": ws.Range("C23").Font.Bold = True
    ws.Range("C24").Value = "a) CGST @9%": ws.Range("F24").Value = "-"
    ws.Range("C25").Value = "b) SGST @ 9%": ws.Range("F25").Value = "-"
    ws.Range("C26").Value = "c) IGST @ 18%": ws.Range("F26").Value = "-"
    ws.Range("F24:F26").HorizontalAlignment = xlCenter
    ws.Range("G26").Value = IGSTValue: ws.Range("G26").HorizontalAlignment = xlRight
    
    ws.Range("C27").Value = "Value of GST [B]": ws.Range("C27").Font.Bold = True
    ws.Range("G27").Value = GSTValue: ws.Range("G27").Font.Bold = True: ws.Range("G27").HorizontalAlignment = xlRight
    
    ws.Range("C29").Value = "Total Payable Amount (C) = (A+B)"
    ws.Range("F29").Value = "-": ws.Range("F29").HorizontalAlignment = xlCenter
    ws.Range("G29").Value = TotalPayable: ws.Range("G29").HorizontalAlignment = xlRight
    ws.Range("B29:H29").Interior.Color = RGB(244, 176, 132): ws.Range("B29:H29").Font.Bold = True
    
    ' --- 6. BOTTOM SECTION ---
    ws.Range("B31:H31").Merge: ws.Range("B31").Value = "Note: TDS and other applicable statutory deductions to be made before releasing the Payment"
    ws.Range("B31").Font.Bold = True: ws.Range("B31").Borders.LineStyle = xlContinuous
    
    ws.Range("C32:E32").Merge: ws.Range("C32").Value = "Details Of Bank Guarantees"
    ws.Range("F32").Value = "Bearing no.": ws.Range("G32").Value = "Valid upto": ws.Range("H32").Value = "Remarks"
    ws.Range("C32:H32").Font.Bold = True
    
    ws.Range("C33:E33").Merge: ws.Range("C33").Value = "Mobilization Advance": ws.Range("F33").Value = "-"
    ws.Range("C34:E34").Merge: ws.Range("C34").Value = "Performance": ws.Range("F34").Value = "NA"
    ws.Range("C35:E35").Merge: ws.Range("C35").Value = "Security/Retention": ws.Range("F35").Value = "NA"
    
    ws.Range("C36:E36").Merge: ws.Range("C36").Value = "Detals Of Insurances"
    ws.Range("F36").Value = "Bearing no.": ws.Range("G36").Value = "Valid upto": ws.Range("H36").Value = "Issued by"
    ws.Range("C36:H36").Font.Bold = True
    
    ws.Range("C37:E37").Merge: ws.Range("C37").Value = "Labour License": ws.Range("F37").Value = "NA"
    
    ws.Range("C38:E38").Merge: ws.Range("C38").Value = "Contractor's AI Risk Policy"
    ws.Range("F38").Value = ContractorsAI: ws.Range("G38").Value = ContractorsAIDate: ws.Range("H38").Value = "Direct Bussiness"
    
    ws.Range("C39:E39").Merge: ws.Range("C39").Value = "Workman s Compensation"
    ws.Range("F39").Value = WorkmanComp: ws.Range("G39").Value = WorkmanCompDate: ws.Range("H39").Value = "Direct Bussiness"
    
    ws.Range("C40:E40").Merge: ws.Range("C40").Value = "Third Party Liability": ws.Range("F40").Value = "NA"
    
    With ws.Range("B32:H40")
        .Borders.LineStyle = xlContinuous: .VerticalAlignment = xlCenter
    End With
    ws.Range("F33:H40").HorizontalAlignment = xlCenter
    
    ' --- 7. FOOTER CERTIFICATION & DATE (UPDATED LOGIC) ---
    
    ' Combine the text
    FullFooterText = CertText1 & vbLf & CertText2 & vbLf & CertText3
    
    With ws.Range("B43:H50")
        .Merge
        .Value = FullFooterText
        .WrapText = True
        .VerticalAlignment = xlTop
        .HorizontalAlignment = xlLeft
        .Borders.LineStyle = xlContinuous
        .Font.Bold = False ' First, make everything Not Bold
        
        ' --- PARTIAL BOLDING LOGIC ---
        ' 1. Find the position of "INR"
        InrPos = InStr(1, FullFooterText, "INR", vbTextCompare)
        ' 2. Find the position of "Prepared by" (end of the bold section)
        PrepPos = InStr(1, FullFooterText, "Prepared by", vbTextCompare)
        
        If InrPos > 0 Then
            If PrepPos > 0 Then
                ' Calculate length: From "INR" up to just before "Prepared by" (minus the newline)
                BoldLength = PrepPos - InrPos - 1
            Else
                ' Fallback: If "Prepared by" not found, bold till end of string
                BoldLength = Len(FullFooterText) - InrPos + 1
            End If
            
            ' Apply Bold ONLY to that range
            .Characters(Start:=InrPos, Length:=BoldLength).Font.Bold = True
        End If
    End With
    
    ' Date Row: Stays at Row 51 & 52 (as per previous instructions)
    With ws.Range("B51:H52")
        .Merge
        .Value = "Date :  " & Format(Date, "dd-mmm-yy")
        .Font.Bold = True
        .Font.Size = 11
        .VerticalAlignment = xlCenter
        .HorizontalAlignment = xlLeft
        .Borders.LineStyle = xlContinuous
    End With
    
    ' --- 8. STAMP ---
    If StampPath <> "" Then
        On Error Resume Next
        Set stampPic = ws.Pictures.Insert(StampPath)
        On Error GoTo 0
        If Not stampPic Is Nothing Then
            With stampPic
                .Top = ws.Range("B47").Top
                .Left = ws.Range("B47").Left + 20
                .ShapeRange.LockAspectRatio = msoTrue
                .Height = 55
            End With
        End If
    End If
    
    ActiveWindow.DisplayGridlines = False
    ActiveWindow.Zoom = 80
    
End Sub

'=============================================================================
' SHEET 3: DETAILED BOQ (Unchanged)
'=============================================================================
Private Sub Process_Sheet3(StampPath As Variant)
    Dim ws As Worksheet
    Dim lastRow As Long, tableEndRow As Long, footerRow As Long, reportBottomRow As Long
    Dim rngHeader As Range, rngTableHeaders As Range, rngTableData As Range
    Dim rngFooterBlock As Range
    Dim cell As Range, r As Long
    Dim stampPic As Picture
    Dim shp As Shape
    Dim ThemeColor As Long
    
    ThemeColor = RGB(0, 32, 96) 'Navy Blue
    
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Sheet3")
    On Error GoTo 0
    If ws Is Nothing Then Exit Sub
    
    ws.Activate
    ActiveWindow.DisplayGridlines = False
    For Each shp In ws.Shapes
        If shp.Type = msoPicture Then shp.Delete
    Next shp
    
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    'Cleanup
    For r = 11 To lastRow
        If InStr(1, ws.Cells(r, 2).Value, "HVAC", vbTextCompare) > 0 Or _
           InStr(1, ws.Cells(r, 2).Value, "DG WORKS", vbTextCompare) > 0 Then
            ws.Range("C" & r & ":H" & r).ClearContents
        End If
    Next r
    For r = 8 To 15
        If ws.Cells(r, 5).Value = "Excess" And ws.Cells(r, 6).Value = "Savings" Then
            ws.Rows(r).Delete: Exit For
        End If
    Next r
    
    ws.Cells.ClearFormats
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    'Find Footer
    footerRow = 0
    For Each cell In ws.Range("A10:A" & lastRow + 10)
        If InStr(1, cell.Value, "Prepared by", vbTextCompare) > 0 Then
            footerRow = cell.Row: Exit For
        End If
    Next cell
    
    If footerRow = 0 Then
        tableEndRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
        footerRow = tableEndRow + 4
        ws.Range("A" & footerRow).Value = "Prepared by"
        ws.Range("A" & footerRow + 1).Value = "Cushman & Wakefield Pvt. Ltd."
    Else
        tableEndRow = footerRow - 2
    End If
    reportBottomRow = footerRow + 5
    
    'Header
    Set rngHeader = ws.Range("A3:H7")
    Application.DisplayAlerts = False
    ws.Range("C3:H3").Merge: ws.Range("C4:H4").Merge: ws.Range("C5:H5").Merge
    ws.Range("C6:H6").Merge: ws.Range("C7:H7").Merge
    Application.DisplayAlerts = True
    With rngHeader
        .Borders.LineStyle = xlContinuous: .Borders.Weight = xlThin: .Borders.Color = vbBlack
        .VerticalAlignment = xlCenter: .Font.Name = "Calibri": .Font.Size = 11
    End With
    ws.Range("A3:A7").Font.Bold = True
    ws.Range("C3:H7").HorizontalAlignment = xlLeft
    
    'Table Headers
    ws.Rows("9:9").Insert Shift:=xlDown
    tableEndRow = tableEndRow + 1: footerRow = footerRow + 1: reportBottomRow = reportBottomRow + 1
    
    Application.DisplayAlerts = False
    ws.Range("A9:A10").Merge: ws.Range("A9").Value = "S. No."
    ws.Range("B9:B10").Merge: ws.Range("B9").Value = "Particulars"
    ws.Range("C9:C10").Merge: ws.Range("C9").Value = "As per WO amount in INR" & vbCrLf & "(Excl. taxes)"
    ws.Range("D9:D10").Merge: ws.Range("D9").Value = "Amount certified by CWI in INR" & vbCrLf & "(Excl. taxes)"
    ws.Range("E9:G9").Merge: ws.Range("E9").Value = "Variance Excluding Taxes in INR"
    ws.Range("E10").Value = "Excess": ws.Range("F10").Value = "Savings": ws.Range("G10").Value = "Total"
    Application.DisplayAlerts = True
    
    Set rngTableHeaders = ws.Range("A9:H10")
    With rngTableHeaders
        .Interior.Color = ThemeColor: .Font.Color = vbWhite: .Font.Bold = True
        .HorizontalAlignment = xlCenter: .VerticalAlignment = xlCenter: .WrapText = True
        .Borders.LineStyle = xlContinuous: .Borders.Weight = xlThin: .Borders.Color = vbWhite
    End With
    
    Set rngTableData = ws.Range("A11:H" & tableEndRow)
    With rngTableData
        .Borders.LineStyle = xlContinuous: .Borders.Weight = xlThin: .Borders.Color = vbBlack
        .VerticalAlignment = xlCenter
    End With
    ws.Range("C11:G" & tableEndRow).NumberFormat = "#,##0.00_);(#,##0.00)"
    ws.Range("A11:A" & tableEndRow).HorizontalAlignment = xlCenter
    
    For r = 11 To tableEndRow
        If InStr(1, ws.Cells(r, 2).Value, "Total", vbTextCompare) > 0 Then ws.Rows(r).Font.Bold = True
        If IsEmpty(ws.Cells(r, 3)) And Not IsEmpty(ws.Cells(r, 2)) Then ws.Rows(r).Font.Bold = True
    Next r
    
    Set rngFooterBlock = ws.Range("A" & (tableEndRow + 1) & ":H" & reportBottomRow)
    With rngFooterBlock
        .ClearFormats: .Interior.Color = vbWhite
    End With
    ws.Range("A" & footerRow).Font.Bold = True
    ws.Range("A" & footerRow + 1).Font.Bold = True
    
    If StampPath <> "" Then
        On Error Resume Next
        Set stampPic = ws.Pictures.Insert(StampPath)
        On Error GoTo 0
        If Not stampPic Is Nothing Then
            With stampPic
                .Top = ws.Range("C" & footerRow).Top
                .Left = ws.Range("C" & footerRow).Left + 15
                .ShapeRange.LockAspectRatio = msoTrue
                .Height = 50
            End With
        End If
    End If
    
    ws.Range("A3:H" & reportBottomRow).BorderAround Weight:=xlThick, Color:=ThemeColor
    
    ws.Columns("A").ColumnWidth = 6: ws.Columns("B").ColumnWidth = 45
    ws.Columns("C:G").ColumnWidth = 18: ws.Columns("H").ColumnWidth = 2
    ws.Rows("3:7").RowHeight = 18: ws.Rows("9:10").RowHeight = 30
End Sub

'=============================================================================
' SHEET 2: VARIANCE ANALYSIS (Unchanged)
'=============================================================================
Private Sub Process_Sheet2(StampPath As Variant)
    Dim ws As Worksheet
    Dim lastRow As Long, tableEndRow As Long, footerRow As Long, reportBottomRow As Long
    Dim rngHeader As Range, rngTableHeaders As Range, rngTableData As Range
    Dim rngFooterBlock As Range
    Dim cell As Range
    Dim stampPic As Picture
    Dim shp As Shape
    Dim ThemeColor As Long
    Dim i As Integer
    
    ThemeColor = RGB(0, 32, 96)
    
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Sheet2")
    On Error GoTo 0
    If ws Is Nothing Then Exit Sub
    
    ws.Activate
    ActiveWindow.DisplayGridlines = False
    For Each shp In ws.Shapes
        If shp.Type = msoPicture Then shp.Delete
    Next shp
    
    ws.Cells.ClearFormats
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    footerRow = 0
    For Each cell In ws.Range("A10:A" & lastRow + 10)
        If InStr(1, cell.Value, "Prepared by", vbTextCompare) > 0 Then
            footerRow = cell.Row: Exit For
        End If
    Next cell
    
    If footerRow = 0 Then
        tableEndRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
        If tableEndRow < 10 Then tableEndRow = 10
        footerRow = tableEndRow + 4
        ws.Range("A" & footerRow).Value = "Prepared by"
        ws.Range("A" & footerRow + 1).Value = "Cushman & Wakefield Pvt. Ltd."
    Else
        tableEndRow = footerRow - 2
    End If
    reportBottomRow = footerRow + 5
    
    Set rngHeader = ws.Range("A3:F7")
    Application.DisplayAlerts = False
    For i = 3 To 7
        ws.Range("B" & i & ":F" & i).Merge
    Next i
    Application.DisplayAlerts = True
    
    With rngHeader
        .Borders.LineStyle = xlContinuous: .Borders.Weight = xlThin: .Borders.Color = vbBlack
        .VerticalAlignment = xlCenter: .Font.Name = "Calibri": .Font.Size = 11
    End With
    ws.Range("A3:A7").Font.Bold = True
    ws.Range("B3:F7").HorizontalAlignment = xlLeft
    
    rngHeader.BorderAround Weight:=xlThick, Color:=ThemeColor
    
    Set rngTableHeaders = ws.Range("A9:F9")
    With rngTableHeaders
        .Interior.Color = ThemeColor: .Font.Color = vbWhite: .Font.Bold = True
        .HorizontalAlignment = xlCenter: .VerticalAlignment = xlCenter: .WrapText = True
        .Borders.LineStyle = xlContinuous: .Borders.Weight = xlThin: .Borders.Color = vbWhite
        .RowHeight = 30
    End With
    
    Set rngTableData = ws.Range("A10:F" & tableEndRow)
    With rngTableData
        .Borders.LineStyle = xlContinuous: .Borders.Weight = xlThin: .Borders.Color = vbBlack
        .VerticalAlignment = xlCenter: .Font.Name = "Calibri": .Font.Size = 11
    End With
    ws.Range("C10:E" & tableEndRow).NumberFormat = "#,##0.00_);(#,##0.00)"
    ws.Range("A10:A" & tableEndRow).HorizontalAlignment = xlCenter
    ws.Range("B10:B" & tableEndRow).HorizontalAlignment = xlLeft
    ws.Range("F10:F" & tableEndRow).HorizontalAlignment = xlLeft
    ws.Range("F10:F" & tableEndRow).WrapText = True
    
    Set rngFooterBlock = ws.Range("A" & (tableEndRow + 1) & ":F" & reportBottomRow)
    With rngFooterBlock
        .ClearFormats: .Interior.Color = vbWhite
    End With
    ws.Range("A" & footerRow).Font.Bold = True
    ws.Range("A" & footerRow + 1).Font.Bold = True
    
    If StampPath <> "" Then
        On Error Resume Next
        Set stampPic = ws.Pictures.Insert(StampPath)
        On Error GoTo 0
        If Not stampPic Is Nothing Then
            With stampPic
                .Top = ws.Range("B" & footerRow).Top - 10
                .Left = ws.Range("B" & footerRow).Left
                .ShapeRange.LockAspectRatio = msoTrue
                .Height = 55
            End With
        End If
    End If
    
    ws.Range("A3:F" & reportBottomRow).BorderAround Weight:=xlThick, Color:=ThemeColor
    
    ws.Columns("A").ColumnWidth = 6
    ws.Columns("B").ColumnWidth = 35
    ws.Columns("C").ColumnWidth = 18
    ws.Columns("D").ColumnWidth = 18
    ws.Columns("E").ColumnWidth = 18
    ws.Columns("F").ColumnWidth = 35
    ws.Rows("3:7").RowHeight = 18
End Sub

`;

function copyMacrosCode() {
    navigator.clipboard.writeText(macrosCode).then(function() {
        const msgDiv = document.getElementById('macrosStatus');
        msgDiv.textContent = '‚úÖ Macros code copied successfully! Now paste it in your Excel VBA editor (Alt + F11).';
        msgDiv.className = 'status-message success';
        msgDiv.style.display = 'block';
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 5000);
    }).catch(function() {
        const msgDiv = document.getElementById('macrosStatus');
        msgDiv.textContent = '‚ùå Failed to copy macros code. Please try again.';
        msgDiv.className = 'status-message error';
        msgDiv.style.display = 'block';
    });
}

function downloadDigitalStamp() {
    const link = document.createElement('a');
    link.href = 'images/digital-stamp.png';
    link.download = 'Cushman_Wakefield_Digital_Stamp.png';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showMessage('‚úÖ Digital stamp downloaded successfully!', 'success');
}
    </script>
</body>
</html>
